<!DOCTYPE html> <html lang="en"> <head> <title>Streaming Vitess at Bolt · Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <link href="https://medium.com/bolt-labs/streaming-vitess-at-bolt-f8ea93211c3f" rel="canonical"> <style>
  @media (min-width: 980px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
  }
  @media (max-width: 979px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
  }
  @media (max-width: 650px) {
    .banner { width: 100%; margin: 0px auto; }
  }
  @media (max-width: 450px) {
    .banner { height: 90px; }
  }
</style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
hljs.initHighlightingOnLoad();
</script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
  /* adjusting the vertical spacing for when a stickynav is engaged */
  .breadcrumb-fixed > .active {
    color: #8c8f91;
  }
  .breadcrumb-fixed {
    margin: 70px 0 10px;
    padding: 8px 15px;
    margin-bottom: 20px;
    list-style: none;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  .breadcrumb-fixed > li {
    display: inline-block;
  }
</style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img src="/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"> </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/documentation/faq/">FAQ</a></li> <li class=""><a href="/documentation/">DOCUMENTATION</a></li> <li class=""><a href="/releases/">RELEASES</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class="active"><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="row post-text-padding row-no-expand"> <div class="hidden-xs col-sm-3 no-right-padding" id="leftdocnav" style="padding-left: 15px; padding-right: 15px;"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"> <span class="icon-home"></span> </div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"> <span class="icon-rss"></span> </div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Featured Posts </div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2020/11/04/streaming-vitess-at-bolt/" style="font-size: 95%;"> Streaming Vitess at Bolt </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;"> Distributed Data for Microservices — Event Sourcing vs. Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/apache-kafka/">apache-kafka</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/apicurio/">apicurio</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/avro/">avro</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/aws/">aws</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/camel/">camel</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/cassandra/">cassandra</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/community/">community</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/cqrs/">cqrs</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/db2/">db2</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/debezium-server/">debezium-server</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/discussion/">discussion</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/docker/">docker</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/elasticsearch/">elasticsearch</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/event-sourcing/">event-sourcing</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/example/">example</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/examples/">examples</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/featured/">featured</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/fedora/">fedora</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/integration/">integration</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/introduction/">introduction</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/json/">json</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka/">kafka</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka-streams/">kafka-streams</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kogito/">kogito</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/ksql/">ksql</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kubernetes/">kubernetes</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/microservices/">microservices</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/mongodb/">mongodb</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/mysql/">mysql</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/news/">news</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/newsletter/">newsletter</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/oracle/">oracle</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/outbox/">outbox</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/postgres/">postgres</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/presentation/">presentation</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/production/">production</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/quarkus/">quarkus</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/rds/">rds</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/releases/">releases</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/schema/">schema</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/secrets/">secrets</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/sentry/">sentry</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/serialization/">serialization</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/smt/">smt</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/sql/">sql</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/sqlserver/">sqlserver</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/testcontainers/">testcontainers</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/topics/">topics</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/vagrant/">vagrant</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/vitess/">vitess</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/website/">website</a> </span> </div> </div> </div> <div class="col-xs-12 col-sm-9" id="maincol"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px;"> <div class="col-sm-12" style="padding-left: 0px;"> <div style="display: table-cell; vertical-align: top;"> <div style="width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block;"> <img src="/images/color_debezium_64px.png" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top;"> <div style="margin-left: 8px;"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1;"> <a href="/blog/2020/11/04/streaming-vitess-at-bolt/">Streaming Vitess at Bolt</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1;"> <a href="/blog/2020/11/04/streaming-vitess-at-bolt/">Streaming Vitess at Bolt</a> </span> <div class="byline" style="line-height: 1;"> <em> November 04, 2020 by Kewei Shang, Ruslan Gibaiev </em> <div class="hidden-xs" style="margin-top: 5px;"> <a class="label label-info hidden-sm hidden-xs" href="/blog/tags/vitess/">vitess</a> </div> </div> </div> </div> </div> </div> <div class="row" style="margin-left: 0; margin-right: 0;"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p><strong><em>This post originally appeared on the <a href="https://medium.com/bolt-labs/streaming-vitess-at-bolt-f8ea93211c3f">Bolt Labs Engineering blog</a>.</em></strong></p> </div> <div class="paragraph"> <p>Traditionally, MySQL has been used to power most of the backend services at <a href="https://bolt.eu/en/">Bolt</a>. We&#8217;ve designed our schemas in a way that they&#8217;re sharded into different MySQL clusters. Each MySQL cluster contains a subset of data and consists of one primary and multiple replication nodes.</p> </div> <div class="paragraph"> <p>Once data is persisted to the database, we use the <a href="https://debezium.io/documentation/reference/connectors/mysql.html">Debezium MySQL Connector</a> to <a href="https://www.confluent.io/blog/how-bolt-adopted-cdc-with-confluent-for-real-time-data-and-analytics/">capture data change events</a> and send them to Kafka. This gives us an easy and reliable way to communicate changes between back-end microservices.</p> </div> </div> </div> <div class="sect1"> <h2 id="vitess_at_bolt"><a class="anchor" href="#vitess_at_bolt"></a>Vitess at Bolt</h2> <div class="sectionbody"> <div class="paragraph"> <p>Bolt has grown considerably over the past few years, and so did the volume of data written to MySQL. Manual database sharding has become quite an expensive and long-lasting process prone to errors. So we started to evaluate more scalable databases, one of which is <a href="https://vitess.io/">Vitess</a>. Vitess is an open-source database clustering system that is based on MySQL and provides horizontal scalability for it. Originated and battle-tested at YouTube, it was later open-sourced and is used by companies like Slack, Github, JD.com to power their backend storage. It combines important MySQL features with the scalability of a NoSQL database.</p> </div> <div class="paragraph"> <p>One of the most important features that Vitess provides is its built-in sharding. It allows the database to grow horizontally by adding new shards in a way that is transparent to back-end application logic. To your application, Vitess appears like a giant single database, but in fact data is partitioned into multiple physical shards behind the scenes. For any table, an arbitrary column can be chosen as the sharding key, and all inserts and updates will be seamlessly directed to a proper shard by Vitess itself.</p> </div> <div class="paragraph"> <p><em>Figure 1</em> below illustrates how back-end services interact with Vitess. At a high level, services connect to the stateless VTGate instances through a load balancer. Each VTGate has the Vitess cluster’s topology cached in its memory and redirects queries to the correct shards and the correct VTTablet (and its underlying MySQL instance) within the shards. More on VTTablet is written below.</p> </div> <div class="exampleblock centered-image responsive-image"> <div class="content"> <img src="/images/vitess/vitess_architecture.png" style="max-width:100%;" class="responsive-image"> <div class="paragraph"> <p><strong>Figure 1. Vitess architecture. Reference: <a href="https://www.planetscale.com/vitess" class="bare">https://www.planetscale.com/vitess</a></strong></p> </div> </div> </div> <div class="paragraph"> <p>Other useful features provided by Vitess are:</p> </div> <div class="ulist"> <ul> <li> <p>Failover (a.k.a. Reparenting) is easy and transparent for clients. Clients only talk to a VTGate who takes care of failover and service discovery of the new primary transparently.</p> </li> <li> <p>It automatically rewrites “problematic” queries that could potentially cause database performance degradation.</p> </li> <li> <p>It has a caching mechanism that prevents duplicate queries to reach the underlying MySQL database simultaneously. Only one query will reach the database and its result will be cached and returned to answer duplicate queries.</p> </li> <li> <p>It has its connection pool and eliminates the high-memory overhead of MySQL connections. As a result, it can easily handle thousands of connections at the same time.</p> </li> <li> <p>Connection timeout and transaction timeout can be configured.</p> </li> <li> <p>It has minimal downtime when doing <a href="https://vitess.io/docs/user-guides/configuration-advanced/resharding/">resharding</a> operations.</p> </li> <li> <p>Its VStream feature can be used by downstream CDC applications to read change events from Vitess.</p> </li> </ul> </div> </div> </div> <div class="sect1"> <h2 id="streaming_vitess_options"><a class="anchor" href="#streaming_vitess_options"></a>Streaming Vitess Options</h2> <div class="sectionbody"> <div class="paragraph"> <p>The ability to capture data changes and publish them to Apache Kafka was one of the requirements for adopting Vitess at Bolt. There were several different options we’ve considered.</p> </div> <div class="sect2"> <h3 id="option_1_using_debezium_mysql_connector"><a class="anchor" href="#option_1_using_debezium_mysql_connector"></a>Option 1: Using Debezium MySQL Connector</h3> <div class="paragraph"> <p>Applications connect to Vitess VTGate to send queries. VTGate supports the MySQL protocol and has a SQL parser. You can use any MySQL client (e.g. JDBC) to connect to VTGate, which redirects your query to the correct shard and returns the result to your client.</p> </div> <div class="paragraph"> <p>However, VTGate is not equal to a MySQL instance, it is rather a stateless proxy to various MySQL instances. For the MySQL connector to receive change events, the Debezium MySQL connector needs to connect to a real MySQL instance. To make it more obvious, VTGate also has some known <a href="https://vitess.io/docs/reference/compatibility/mysql-compatibility/">compatibility</a> issues, which makes connecting to VTGate different from MySQL.</p> </div> <div class="paragraph"> <p>Another option is to use the Debezium MySQL Connector to connect directly to the underlying MySQL instances of different shards. It has its advantages and disadvantages.</p> </div> <div class="paragraph"> <p>One advantage is that for an unsharded keyspace (Vitess&#8217;s terminology for a database), the MySQL Connector can continue to work correctly and we don&#8217;t need to include additional logic or specific implementation. It should just work fine.</p> </div> <div class="paragraph"> <p>One of the biggest disadvantages is that resharding operations would become more complex. For example, the GTID of the original MySQL instance would change when resharded, and the MySQL connector depends on the GTID to work correctly. We also believe that having the MySQL connector connected directly to each underlying MySQL instance defies the purpose of Vitess&#8217;s operational simplicity as a new connector has to be added (or removed) each time resharding is done. Not to mention that such operation would lead to data duplication inside Kafka brokers.</p> </div> </div> <div class="sect2"> <h3 id="option_2_using_jdbc_source_connector"><a class="anchor" href="#option_2_using_jdbc_source_connector"></a>Option 2: Using JDBC Source Connector</h3> <div class="paragraph"> <p>We&#8217;ve also considered using the <a href="https://docs.confluent.io/current/connect/kafka-connect-jdbc/source-connector/index.html">JDBC Source Connector</a>. It allows sourcing data from any relational databases that support the JDBC driver into Kafka. Therefore, it is compatible with Vitess VTGate. It has its advantages and disadvantages as well.</p> </div> <div class="paragraph"> <p>Advantages:</p> </div> <div class="ulist"> <ul> <li> <p>It is compatible with VTGate.</p> </li> <li> <p>It handles Vitess resharding operation better. During resharding operation, reads are simply automatically redirected (by VTGate) to the target shards. It won&#8217;t generate any duplicates or lose any data.</p> </li> </ul> </div> <div class="paragraph"> <p>Disadvantages:</p> </div> <div class="ulist"> <ul> <li> <p>It is poll-based, meaning that the connector polls the database for new change events on a defined interval (typically every few seconds). This means that we would have a much higher latency, compared to the Debezium MySQL Connector.</p> </li> <li> <p>Its offsets are managed by either the table&#8217;s incremental primary key or one of the table&#8217;s timestamp columns. If we use the timestamp column for offset, we&#8217;d have to create a secondary-index of the timestamp column for each table. This adds more constraints on our backend services. If we use the incremental primary key, we would miss the change events for row-updates because the primary key is simply not updated.</p> </li> <li> <p>The topic name created by the JDBC connector doesn&#8217;t include the table&#8217;s schema name. Using the <code>topic.prefix</code> connector configuration would mean that we&#8217;ll have one connector per schema. At Bolt, we have a large number of schemas, which means we would need to create a large number of JDBC Source Connectors.</p> </li> <li> <p>At Bolt, our downstream applications are already set up to use Debezium&#8217;s data formats and topic naming conventions, e.g. we&#8217;d need to change our downstream application&#8217;s decoding logic to the new data formats.</p> </li> <li> <p>Row deletes are not captured.</p> </li> </ul> </div> </div> <div class="sect2"> <h3 id="option_3_using_vstream_grpc"><a class="anchor" href="#option_3_using_vstream_grpc"></a>Option 3: Using VStream gRPC</h3> <div class="paragraph"> <p>VTGate exposes a gRPC service called VStream. It is a server-side streaming service. Any gRPC client can subscribe to the <a href="https://vitess.io/docs/concepts/vstream/">VStream</a> service to get a continuous stream of change events from the underlying MySQL instances. The change events that VStream emits have similar information to the MySQL binary logs of the underlying MySQL instances. A single VStream can even subscribe to multiple shards for a given keyspace, making it quite a convenient API to build CDC tools.</p> </div> <div class="paragraph"> <p>Behind the scene, as shown in <em>Figure 2</em>, VStream reads change events from multiple <a href="https://vitess.io/docs/reference/programs/vttablet/">VTTablets</a>, one VTTablet per shard. Therefore, it doesn’t send duplicates from multiple VTTablets for a given shard. Each VTTablet is a proxy to its MySQL instance. A typical topology would include one master VTTablet and its corresponding MySQL instance, and multiple replica VTTablets, each of which is the proxy of its own replica MySQL instance. A VTTablet gets change events from its underlying MySQL instance and sends the change events back to VTGate, which in turn sends the change events back to VStream’s gRPC client.</p> </div> <div class="paragraph"> <p>When subscribing to the VStream service, the client can specify a VGTID and <a href="https://vitess.io/docs/concepts/tablet/#tablet-types">Tablet Type</a> (e.g. <code>MASTER</code>, <code>REPLICA</code>). The VGTID tells the position from which VStream starts to send change events. Essentially, VGTID includes a list of (keyspace, shard, shard GTID) tuples. The Tablet Type tells which MySQL instance (primary or replica) in each shard do we read change events from.</p> </div> <div class="exampleblock centered-image responsive-image"> <div class="content"> <img src="/images/vitess/vstream.png" style="max-width:100%;" class="responsive-image"> <div class="paragraph"> <p><strong>Figure 2. VStream architecture. Reference: <a href="https://vitess.io/docs/concepts/vstream" class="bare">https://vitess.io/docs/concepts/vstream</a></strong></p> </div> </div> </div> <div class="paragraph"> <p>Some advantages of using VStream gRPC are:</p> </div> <div class="ulist"> <ul> <li> <p>It is a simple way to receive change events from Vitess. It is also recommended in Vitess’s <a href="https://vitess.io/docs/concepts/vstream/">documentation</a> to use VStream to build CDC processes downstream.</p> </li> <li> <p>VTGate hides the complexity of connecting to various source MySQL instances.</p> </li> <li> <p>It has low latency since change events are streamed to the client as soon as they happen.</p> </li> <li> <p>The change events include not only inserts and updates, but also deletes.</p> </li> <li> <p>Probably one of the biggest advantages is that the change events contain the schema of each table. So you don’t have to worry about fetching each table’s schema in advance (by, for example, parsing DDLs or querying the table’s definition).</p> </li> <li> <p>The change events have VGTID included, which the CDC process can store and use as the offset from where to restart the CDC process next time.</p> </li> <li> <p>Also importantly, VStream is designed to work well with Vitess operations such as <a href="https://vitess.io/docs/user-guides/resharding/">Resharding</a> and <a href="https://vitess.io/docs/user-guides/move-tables/">Moving Tables</a>.</p> </li> </ul> </div> <div class="paragraph"> <p>There are also some disadvantages:</p> </div> <div class="ulist"> <ul> <li> <p>Although it includes table schemas, some important information is still missing. For example, the <code>Enum</code> and <code>Set</code> column types don’t provide all the allowed values yet. This should be fixed in the next major release (Vitess 9) though.</p> </li> <li> <p>Since VStream is a gRPC service, we cannot use the Debezium MySQL Connector out-of-the-box. However, it is quite straightforward to implement the gRPC client in other languages.</p> </li> </ul> </div> <div class="paragraph"> <p>All things considered, we’ve decided to use VStream gRPC to capture change events from Vitess and implement our Vitess Connector based on all the best practices of Debezium.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="vitess_connector_deep_dive_and_open_source"><a class="anchor" href="#vitess_connector_deep_dive_and_open_source"></a>Vitess Connector Deep Dive and Open Source</h2> <div class="sectionbody"> <div class="paragraph"> <p>After we’ve decided to implement our Vitess Connector, we started looking into the implementation details of various Debezium source connectors (MySQL, Postgres, SQLServer), to borrow some ideas. Almost all of them are implemented using a common Connector development framework. So it was clear we should develop the Vitess connector on top of it. Given we are very active users of the MySql Connector and we benefit from it being open-sourced, as it allows us to contribute to it things we were missing ourselves. So we decided we want to give back to community and open-source the Vitess source connector code-base under the Debezium umbrella. Please feel free to learn more at <a href="https://github.com/debezium/debezium-connector-vitess/">Debezium Connector Vitess</a>. We welcome and value any contributions.</p> </div> <div class="paragraph"> <p>At a high level, as you can see below, connector instances are created in Kafka Connect workers. At the time of writing, you have two options to configure the connector to read from Vitess:</p> </div> <div class="paragraph"> <p><strong>Option 1 (recommended):</strong></p> </div> <div class="paragraph"> <p>As shown in <em>Figure 3</em>, each connector captures change events from all shards in a specific keyspace. If the keyspace is not sharded, the connector can still capture change events from the only shard in the keyspace. When it’s the first time that the connector starts, it reads from the current VGTID position of all shards in the keyspace. Because it subscribes to all shards, it continuously captures change events from all shards and sends them to Kafka. It automatically supports the Vitess Reshard operation, there is no data loss, nor duplication.</p> </div> <div class="exampleblock centered-image responsive-image"> <div class="content"> <img src="/images/vitess/vitess_connector_multi_shards.png" style="max-width:100%;" class="responsive-image"> <div class="paragraph"> <p><strong>Figure 3. Each connector subscribes to all shards of a specific keyspace</strong></p> </div> </div> </div> <div class="paragraph"> <p><strong>Option 2:</strong></p> </div> <div class="paragraph"> <p>As shown in <em>Figure 4</em>, each connector instance captures change events from a specific keyspace/shard pair. The connector instance gets the initial (the current) VGTID position of the keyspace/shard pair from VTCtld gRPC, which is another Vitess component. Each connector instance, independently, uses the VGTID it gets to subscribe to VStream gRPC and continuously capture change events from VStream and sends them to Kafka. To support the Vitess Reshard operation, you would need more manual operations.</p> </div> <div class="exampleblock centered-image responsive-image"> <div class="content"> <img src="/images/vitess/vitess_connector_single_shard.png" style="max-width:100%;" class="responsive-image"> <div class="paragraph"> <p><strong>Figure 4. Each connector subscribes to one shard of a specific keyspace</strong></p> </div> </div> </div> <div class="paragraph"> <p>Internally, each connector task uses a gRPC thread to constantly receive change events from VStream and puts the events into an internal blocking queue. The connector task thread polls events out of the queue and sends them to Kafka, as can be seen in <em>Figure 5</em>.</p> </div> <div class="exampleblock centered-image responsive-image"> <div class="content"> <img src="/images/vitess/vitess_connector_internal.png" style="max-width:100%;" class="responsive-image"> <div class="paragraph"> <p><strong>Figure 5. How each connector task works internally</strong></p> </div> </div> </div> <div class="sect2"> <h3 id="replication_challenges"><a class="anchor" href="#replication_challenges"></a>Replication Challenges</h3> <div class="paragraph"> <p>While we were implementing the Vitess Connector and digging deeper into Vitess, we’ve also realized a few challenges.</p> </div> <div class="sect3"> <h4 id="vitess_reshard"><a class="anchor" href="#vitess_reshard"></a>Vitess Reshard</h4> <div class="paragraph"> <p>The Vitess connector supports the Vitess Reshard operation when the connector is configured to subscribe to all shards of a given keyspace. VStream sends a VGTID that contains the shard GTID for all shards. Vitess Resharding is transparent to users. Once it’s completed, Vitess will send the VGTID of the new shards. Therefore, the connector will use the new VGTID after reshard. However, you need to make sure that the connector is up and running when the reshard operation takes place. Especially please check that the offset topic of the connector has the new VGTID before deleting the old shards. This is because in case the old shards are deleted, VStream will not be able to recognize the VGTID from the old shards.</p> </div> <div class="paragraph"> <p>If you decide to subscribe to one shard per connector, the connector does not provide out-of-the-box support for Vitess resharding. One manual workaround to support resharding is creating one new connector per target shard. For example, one new connector for the <code>commerce/-80</code> shard, and another new connector for the <code>commerce/80-</code> shard. Bear in mind that because they’re new connectors, by default, new topics will be created, however, you could use the <a href="https://debezium.io/documentation/reference/configuration/topic-routing.html">Debezium logical topic router</a> to route the records to the same Kafka topics.</p> </div> </div> <div class="sect3"> <h4 id="offset_management"><a class="anchor" href="#offset_management"></a>Offset Management</h4> <div class="paragraph"> <p>VStream includes a VGTID event in its response. We save the VGTID as the offset in the Kafka offset topic, so when the connector restarts, we can start from the saved VGTID. However, in rare cases when a transaction includes a huge amount of rows, VStream batches the change events into multiple responses, and only the last response has the VGTID. In such cases, we don’t have the VGTID for every change event we receive. We have a few options to solve this particular issue:</p> </div> <div class="ulist"> <ul> <li> <p>We can buffer all the change events in memory and wait for the last response that contains the VGTID to arrive. So all events will have the correct VGTID associated with them. A few disadvantages are that we’ll have higher latency before events are sent to Kafka. Also, memory usage could potentially increase quite a lot due to buffering. Buffering also adds complexity to the logic. We also have no control over the number of events VStream sends to us.</p> </li> <li> <p>We can use the latest VGTID we have, which is the VGTID from the previous VStream response. If the connector fails and restarts when processing such a big transaction, it’ll restart from the VGTID of the previous VStream response, thus reprocessing some events. Therefore, it has at-least-once event delivery semantics and it expects the downstream to be idempotent. Since most transactions are not big enough, most VStream responses will have VGTID in the response, so the chance of having duplicates is low. In the end, we chose this approach for its at-least-once delivery guarantee and its design simplicity.</p> </li> </ul> </div> </div> <div class="sect3"> <h4 id="schema_management"><a class="anchor" href="#schema_management"></a>Schema Management</h4> <div class="paragraph"> <p>VStream’s response also includes a <code>FIELD</code> event. It’s a special event that contains the schemas of the tables of which the rows are affected. For example, let&#8217;s assume we have 2 tables, <code>A</code> and <code>B</code>. If we insert a few rows into table <code>A</code>, the <code>FIELD</code> event will only contain table <code>A</code>’s schema. The VStream is smart enough to only include the <code>FIELD</code> event whenever necessary. For example, when a VStream client reconnects, or when a table’s schema is changed.</p> </div> <div class="paragraph"> <p>The older version of VStream includes only the column type (e.g. <code>Integer</code>, <code>Varchar</code>), no additional information such as whether the column is the primary key, whether the column has a default value, <code>Decimal</code> type’s scale and precision, <code>Enum</code> type’s allowed values, etc.</p> </div> <div class="paragraph"> <p>The newer version (Vitess 8) of VStream starts to include more information on each column. This will help the connector to deserialize more accurately certain types and have a more precise schema in the change events sent to Kafka.</p> </div> </div> </div> </div> </div> <div class="sect1"> <h2 id="future_development_work"><a class="anchor" href="#future_development_work"></a>Future Development Work</h2> <div class="sectionbody"> <div class="ulist"> <ul> <li> <p>We can use VStream&#8217;s API to start streaming from the latest VGTID position, instead of getting the initial VGTID position from VTCtld gRPC. Doing so would eliminate the dependency from VTCtld.</p> </li> <li> <p>We don’t support automatically extracting the primary keys from the change events yet. Currently, by default, all change events sent to Kafka have <code>null</code> as the key, unless the <code>message.key.columns</code> connector configuration is specified. Vitess recently added flags of each column in the VStream FIELD event, which allows us to implement this feature soon.</p> </li> <li> <p>Add support for initial snapshots to capture all existing data before streaming changes.</p> </li> </ul> </div> </div> </div> <div class="sect1"> <h2 id="summary"><a class="anchor" href="#summary"></a>Summary</h2> <div class="sectionbody"> <div class="paragraph"> <p>MySQL has been used to power most of our backend services at Bolt. Due to the considerable growth of the volume of data and operational complexity, Bolt started to evaluate Vitess for its scalability and its built-in features such as resharding.</p> </div> <div class="paragraph"> <p>To capture data changes from Vitess, as what we’ve been doing with Debezium MySQL Connector, we’ve considered a few options. In the end, we have implemented our own Vitess Connector based on the common Debezium connector framework. While implementing the Vitess connector, we’ve encountered a few challenges. For example, support for the Vitess reshard operation, offset management, and schema management. We reasoned about ways to address the challenges and what we worked out as solutions.</p> </div> <div class="paragraph"> <p>We’ve also received quite some interest from multiple communities in this project and we’ve decided to open-source <a href="https://github.com/debezium/debezium-connector-vitess/">Vitess Connector</a> under the Debezium umbrella. Please feel free to learn more, and we welcome and value any contributions.</p> </div> </div> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Kewei Shang</h2> <p> <span class="bio-size">Kewei is a Senior Software Engineer at Bolt, where he focuses mainly on Kafka, Debezium, change data capture, data warehousing, and creating event-driven systems.</span> </p> <p class="bio-size"> <a href="https://twitter.com/keweishang"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/keweishang"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/images/keweishang.jpg"> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Ruslan Gibaiev</h2> <p> <span class="bio-size">Ruslan is a Streaming Platform lead at Bolt. He likes building distributed systems and prefers real-time data to batch processing.</span> </p> <p class="bio-size"> <a href="https://twitter.com/rgibaiev"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/rgibaiev"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/images/rgibaiev.jpg"> </div> </div> </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
            var disqus_shortname = 'Debezium';
            var disqus_url = "https://debezium.io/blog/2020/11/04/streaming-vitess-at-bolt/";
            var disqus_developer = null;
            var disqus_identifier = null;
            (function() {
              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=Debezium">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2020 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/documentation/features" title="Features">Features</a> </li> <li> <a href="/documentation/install/stable/" title="Install">Install</a> </li> <li> <a href="/documentation/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/documentation/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/user" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
  var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
  var urlSplit = coreUrl.toLowerCase().split(/\//);
  var urlLast = urlSplit[urlSplit.length-1];
  var pageNameString = "";
  var siteName = "";
  var minorSectionIndex = 3
  if (urlLast == "") {
      urlSplit.splice(-1,1);
  }
  if (urlLast.search(/\./) >= 0) {
      if (urlLast == "index.html") {
          urlSplit.splice(-1,1);
      }
      else {
          urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
      }
  }
  siteName = urlSplit[2].split(".")[1];
  s.prop14 = s.eVar27 = siteName || "";
  s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
  s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
  pageNameString = urlSplit.splice(3).join(" | ");
  s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
  s.server = "jboss";
  s.channel = "jboss | community";
  s.prop4 = s.eVar23 = encodeURI(document.URL);
  s.prop21 = s.eVar18 = coreUrl;
  s.prop2 = s.eVar22 = "en";
  s.prop3 = s.eVar19 = "us";
  //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
  if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
  //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script> <script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-10656779-1");
pageTracker._trackPageview();
} catch(err) {}</script> <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-76464546-1', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);
ga('require', 'linkid', 'linkid.js');

</script> </div> </body> </html>