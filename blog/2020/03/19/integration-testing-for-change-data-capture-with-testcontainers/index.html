<!DOCTYPE html> <html lang="en"> <head> <title>Integration Testing for Change Data Capture with Testcontainers · Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
  @media (min-width: 980px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
  }
  @media (max-width: 979px) {
    .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
  }
  @media (max-width: 650px) {
    .banner { width: 100%; margin: 0px auto; }
  }
  @media (max-width: 450px) {
    .banner { height: 90px; }
  }
</style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
hljs.initHighlightingOnLoad();
</script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
  /* adjusting the vertical spacing for when a stickynav is engaged */
  .breadcrumb-fixed > .active {
    color: #8c8f91;
  }
  .breadcrumb-fixed {
    margin: 70px 0 10px;
    padding: 8px 15px;
    margin-bottom: 20px;
    list-style: none;
    background-color: #f5f5f5;
    border-radius: 4px;
  }
  
  .breadcrumb-fixed > li {
    display: inline-block;
  }
</style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> <img src="/images/color_white_debezium_type_600px.svg" style="height: 32px; margin-right: 5px; margin-top: -5px;"> </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/documentation/faq/">FAQ</a></li> <li class=""><a href="/documentation/">DOCUMENTATION</a></li> <li class=""><a href="/releases/">RELEASES</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class="active"><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="row post-text-padding row-no-expand"> <div class="hidden-xs col-sm-3 no-right-padding" id="leftdocnav" style="padding-left: 15px; padding-right: 15px;"> <div class="doc-pills"> <ul class="nav nav-pills nav-stacked"> <li class="item"> <a href="/blog">Home</a> <div class="icon"> <span class="icon-home"></span> </div> </li> <li class="item"> <a href="/blog.atom">Feed</a> <div class="icon"> <span class="icon-rss"></span> </div> </li> </ul> </div> <p></p> <div class="featured-posts"> <div id="featured" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Featured Posts </div> <ul style="padding-inline-start: 22px;"> <li style="margin-bottom: 3px;"> <a href="/blog/2020/02/10/event-sourcing-vs-cdc/" style="font-size: 95%;"> Distributed Data for Microservices — Event Sourcing vs. Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/10/01/audit-logs-with-change-data-capture-and-stream-processing/" style="font-size: 95%;"> Building Audit Logs with Change Data Capture and Stream Processing </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/07/12/streaming-cassandra-at-wepay-part-1/" style="font-size: 95%;"> Streaming Cassandra at WePay - Part 1 </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2019/02/19/reliable-microservices-data-exchange-with-the-outbox-pattern/" style="font-size: 95%;"> Reliable Microservices Data Exchange With the Outbox Pattern </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/12/05/automating-cache-invalidation-with-change-data-capture/" style="font-size: 95%;"> Automating Cache Invalidation With Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/09/20/materializing-aggregate-views-with-hibernate-and-debezium/" style="font-size: 95%;"> Materializing Aggregate Views With Hibernate and Debezium </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/07/19/advantages-of-log-based-change-data-capture/" style="font-size: 95%;"> Five Advantages of Log-Based Change Data Capture </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/03/08/creating-ddd-aggregates-with-debezium-and-kafka-streams/" style="font-size: 95%;"> Creating DDD aggregates with Debezium and Kafka Streams </a> </li> <li style="margin-bottom: 3px;"> <a href="/blog/2018/01/17/streaming-to-elasticsearch/" style="font-size: 95%;"> Streaming Data Changes from Your Database to Elasticsearch </a> </li> </ul> </div> <p></p> <div class="cloud-tags"> <div id="tags" style="margin-bottom: 4px; border-bottom: 1px solid #ccc; font-size: 115%; margin-left: 2px;"> Tags </div> <div class="tag-cloud"> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/apache-kafka/">apache-kafka</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/apicurio/">apicurio</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/avro/">avro</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/aws/">aws</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/camel/">camel</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/cassandra/">cassandra</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/community/">community</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/cqrs/">cqrs</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/db2/">db2</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/debezium-server/">debezium-server</a> </span> <span class="tag tag-2"> <a href="https://debezium.io/blog/tags/discussion/">discussion</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/docker/">docker</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/elasticsearch/">elasticsearch</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/event-sourcing/">event-sourcing</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/example/">example</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/examples/">examples</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/featured/">featured</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/fedora/">fedora</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/integration/">integration</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/introduction/">introduction</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/json/">json</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka/">kafka</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/kafka-streams/">kafka-streams</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kogito/">kogito</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/ksql/">ksql</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/kubernetes/">kubernetes</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/microservices/">microservices</a> </span> <span class="tag tag-4"> <a href="https://debezium.io/blog/tags/mongodb/">mongodb</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/mysql/">mysql</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/news/">news</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/newsletter/">newsletter</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/oracle/">oracle</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/outbox/">outbox</a> </span> <span class="tag tag-5"> <a href="https://debezium.io/blog/tags/postgres/">postgres</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/presentation/">presentation</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/production/">production</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/quarkus/">quarkus</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/rds/">rds</a> </span> <span class="tag tag-6"> <a href="https://debezium.io/blog/tags/releases/">releases</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/schema/">schema</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/secrets/">secrets</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/sentry/">sentry</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/serialization/">serialization</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/smt/">smt</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/sql/">sql</a> </span> <span class="tag tag-3"> <a href="https://debezium.io/blog/tags/sqlserver/">sqlserver</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/testcontainers/">testcontainers</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/topics/">topics</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/vagrant/">vagrant</a> </span> <span class="tag tag-0"> <a href="https://debezium.io/blog/tags/vitess/">vitess</a> </span> <span class="tag tag-1"> <a href="https://debezium.io/blog/tags/website/">website</a> </span> </div> </div> </div> <div class="col-xs-12 col-sm-9" id="maincol"> <div class="post"> <div class="row" style="margin-left: 0; margin-right: 0; margin-bottom: 10px;"> <div class="col-sm-12" style="padding-left: 0px;"> <div style="display: table-cell; vertical-align: top;"> <div style="width: 72px; border: 1px solid #ccc; padding: 3px; display: inline-block;"> <img src="/images/gmorling.jpg" style="width: 64px;"> </div> </div> <div style="display: table-cell; vertical-align: top;"> <div style="margin-left: 8px;"> <span class="hidden-sm hidden-xs" style="font-size: 2.75rem; line-height: 1;"> <a href="/blog/2020/03/19/integration-testing-for-change-data-capture-with-testcontainers/">Integration Testing for Change Data Capture with Testcontainers</a> </span> <span class="hidden-md hidden-lg" style="font-size: 2rem; line-height: 1;"> <a href="/blog/2020/03/19/integration-testing-for-change-data-capture-with-testcontainers/">Integration Testing for Change Data Capture with Testcontainers</a> </span> <div class="byline" style="line-height: 1;"> <em> March 19, 2020 by Gunnar Morling </em> <div class="hidden-xs" style="margin-top: 5px;"> <a class="label label-info hidden-sm hidden-xs" href="/blog/tags/discussion/">discussion</a> <a class="label label-info hidden-sm hidden-xs" href="/blog/tags/testcontainers/">testcontainers</a> <a class="label label-info hidden-sm hidden-xs" href="/blog/tags/postgres/">postgres</a> </div> </div> </div> </div> </div> </div> <div class="row" style="margin-left: 0; margin-right: 0;"> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Setting up change data capture (CDC) pipelines with Debezium typically is a matter of configuration, without any programming being involved. It&#8217;s still a very good idea to have automated tests for your CDC set-up, making sure that everything is configured correctly and that your Debezium connectors are set up as intended.</p> </div> <div class="paragraph"> <p>There&#8217;s two main components involved whose configuration need consideration:</p> </div> <div class="ulist"> <ul> <li> <p><strong>The source database:</strong> it must be set up so that Debezium can connect to it and retrieve change events; details depend on the specific database, e.g. for MySQL the binlog must be in "row" mode, for Postgres, one of the supported logical decoding plug-ins must be installed, etc.</p> </li> <li> <p><strong>The Debezium connector:</strong> it must be configured using the right database host and credentials, possibly using SSL, applying table and column filters, potentially one or more single message transformations (SMTs), etc.</p> </li> </ul> </div> <div class="paragraph"> <p></p> </div> <div class="paragraph"> <p>This is where the newly added Debezium <a href="https://debezium.io/documentation/reference/1.1/integrations/testcontainers.html">support for integration tests</a> with <a href="https://www.testcontainers.org/">Testcontainers</a> comes in. It allows to set up all the required components (Apache Kafka, Kafka Connect etc.) using Linux container images, configure and deploy a Debezium connector and run assertions against produced change data events.</p> </div> <div class="paragraph"> <p>Let&#8217;s take a look at how it&#8217;s done.</p> </div> </div> </div> <div class="sect1"> <h2 id="project_set_up"><a class="anchor" href="#project_set_up"></a>Project Set-Up</h2> <div class="sectionbody"> <div class="paragraph"> <p>Assuming you&#8217;re working with Apache Maven for dependency management, add the following dependencies to your <em>pom.xml</em>, pulling in the Debezium Testcontainers integration and the Testcontainers <a href="https://www.testcontainers.org/modules/kafka/">module for Apache Kafka</a>:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;&#x000A;  &lt;groupId&gt;io.debezium&lt;/groupId&gt;&#x000A;  &lt;artifactId&gt;debezium-testing-testcontainers&lt;/artifactId&gt;&#x000A;  &lt;version&gt;1.1.0.CR1&lt;/version&gt;&#x000A;  &lt;scope&gt;test&lt;/scope&gt;&#x000A;&lt;/dependency&gt;&#x000A;&lt;dependency&gt;&#x000A;  &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;&#x000A;  &lt;artifactId&gt;kafka&lt;/artifactId&gt;&#x000A;  &lt;scope&gt;test&lt;/scope&gt;&#x000A;&lt;/dependency&gt;</code></pre> </div> </div> <div class="paragraph"> <p>Also add the Testcontainers dependency for your database, e.g. Postgres:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;&#x000A;  &lt;groupId&gt;org.testcontainers&lt;/groupId&gt;&#x000A;  &lt;artifactId&gt;postgresql&lt;/artifactId&gt;&#x000A;  &lt;scope&gt;test&lt;/scope&gt;&#x000A;&lt;/dependency&gt;</code></pre> </div> </div> <div class="paragraph"> <p>You can find an example project with the complete configuration in the <a href="https://github.com/debezium/debezium-examples/tree/master/testcontainers">debezium-examples</a> repo on GitHub.</p> </div> </div> </div> <div class="sect1"> <h2 id="initializing_testcontainers"><a class="anchor" href="#initializing_testcontainers"></a>Initializing Testcontainers</h2> <div class="sectionbody"> <div class="paragraph"> <p>Having declared all the required dependencies, it&#8217;s time to write a CDC integration test. With Testcontainers, integration tests are implemented using Linux containers and Docker. It provides a Java API for starting and managing the resources needed by a test. We can use this to fire up Apache Kafka, Kafka Connect and a Postgres database:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">public class CdcTest {&#x000A;&#x000A;  private static Network network = Network.newNetwork(); <i class="conum" data-value="1"></i><b>(1)</b>&#x000A;&#x000A;  private static KafkaContainer kafkaContainer = new KafkaContainer()&#x000A;      .withNetwork(network); <i class="conum" data-value="2"></i><b>(2)</b>&#x000A;&#x000A;  public static PostgreSQLContainer&lt;?&gt; postgresContainer =&#x000A;      new PostgreSQLContainer&lt;&gt;("debezium/postgres:11")&#x000A;          .withNetwork(network)&#x000A;          .withNetworkAliases("postgres"); <i class="conum" data-value="3"></i><b>(3)</b>&#x000A;&#x000A;  public static DebeziumContainer debeziumContainer =&#x000A;      new DebeziumContainer("1.1.0.CR1")&#x000A;          .withNetwork(network)&#x000A;          .withKafka(kafkaContainer)&#x000A;          .dependsOn(kafkaContainer); <i class="conum" data-value="4"></i><b>(4)</b>&#x000A;&#x000A;  @BeforeClass&#x000A;  public static void startContainers() { <i class="conum" data-value="5"></i><b>(5)</b>&#x000A;    Startables.deepStart(Stream.of(&#x000A;        kafkaContainer, postgresContainer, debeziumContainer))&#x000A;            .join();&#x000A;  }&#x000A;}</code></pre> </div> </div> <div class="colist arabic"> <table> <tr> <td><i class="conum" data-value="1"></i><b>1</b></td> <td>Define a Docker network to be used by all the services</td> </tr> <tr> <td><i class="conum" data-value="2"></i><b>2</b></td> <td>Set up a container for Apache Kafka</td> </tr> <tr> <td><i class="conum" data-value="3"></i><b>3</b></td> <td>Set up a container for Postgres 11 (using Debezium&#8217;s Postgres container image)</td> </tr> <tr> <td><i class="conum" data-value="4"></i><b>4</b></td> <td>Set up a container for Kafka Connect with Debezium</td> </tr> <tr> <td><i class="conum" data-value="5"></i><b>5</b></td> <td>Start all three containers in a <code>@BeforeClass</code> method</td> </tr> </table> </div> <div class="paragraph"> <p>Note that you need to have Docker installed in order to use Testcontainers.</p> </div> </div> </div> <div class="sect1"> <h2 id="the_test_implementation"><a class="anchor" href="#the_test_implementation"></a>The Test Implementation</h2> <div class="sectionbody"> <div class="paragraph"> <p>With the needed infrastructure in place, we can write a test for our CDC set-up. The overall flow of the test is this:</p> </div> <div class="ulist"> <ul> <li> <p>Configure a Debezium connector for the Postgres database</p> </li> <li> <p>Execute a few SQL statements to change some data</p> </li> <li> <p>Retrieve the resulting change data events from the corresponding Kafka topic using a Kafka consumer</p> </li> <li> <p>Run some assertions against these events</p> </li> </ul> </div> <div class="paragraph"> <p>Here&#8217;s the shell for the test:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">@Test&#x000A;public void canObtainChangeEventsFromPostgres() throws Exception {&#x000A;  try (Connection connection = getConnection(postgresContainer);&#x000A;      Statement statement = connection.createStatement();&#x000A;      KafkaConsumer&lt;String, String&gt; consumer =&#x000A;          getConsumer(kafkaContainer)) {&#x000A;&#x000A;      // TODO ...&#x000A;  }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>The credentials for the database connection can be obtained from the Postgres container started via Testcontainers, nicely avoiding any redundancies:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">private Connection getConnection(PostgreSQLContainer&lt;?&gt; postgresContainer)&#x000A;    throws SQLException {&#x000A;&#x000A;  return DriverManager.getConnection(postgresContainer.getJdbcUrl(),&#x000A;      postgresContainer.getUsername(),&#x000A;      postgresContainer.getPassword());&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>The same goes for the Kafka consumer:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">private KafkaConsumer&lt;String, String&gt; getConsumer(&#x000A;    KafkaContainer kafkaContainer) {&#x000A;&#x000A;  return new KafkaConsumer&lt;&gt;(&#x000A;      ImmutableMap.of(&#x000A;          ConsumerConfig.BOOTSTRAP_SERVERS_CONFIG,&#x000A;          kafkaContainer.getBootstrapServers(),&#x000A;&#x000A;          ConsumerConfig.GROUP_ID_CONFIG,&#x000A;          "tc-" + UUID.randomUUID(),&#x000A;&#x000A;          ConsumerConfig.AUTO_OFFSET_RESET_CONFIG,&#x000A;          "earliest"),&#x000A;      new StringDeserializer(),&#x000A;      new StringDeserializer());&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>Now let&#8217;s implement the actual test logic:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlight"><code class="language-java" data-lang="java">statement.execute("create schema todo"); <i class="conum" data-value="1"></i><b>(1)</b>&#x000A;statement.execute("create table todo.Todo (" +&#x000A;                    "id int8 not null, " +&#x000A;                    "title varchar(255), " +&#x000A;                    "primary key (id))");&#x000A;statement.execute("alter table todo.Todo replica identity full");&#x000A;statement.execute("insert into todo.Todo values (1, 'Learn CDC')");&#x000A;statement.execute("insert into todo.Todo values (2, 'Learn Debezium')");&#x000A;&#x000A;ConnectorConfiguration connector = ConnectorConfiguration&#x000A;        .forJdbcContainer(postgresContainer)&#x000A;        .with("database.server.name", "dbserver1");&#x000A;&#x000A;debeziumContainer.registerConnector("my-connector",&#x000A;        connector); <i class="conum" data-value="2"></i><b>(2)</b>&#x000A;&#x000A;consumer.subscribe(Arrays.asList("dbserver1.todo.todo"));&#x000A;&#x000A;List&lt;ConsumerRecord&lt;String, String&gt;&gt; changeEvents =&#x000A;        drain(consumer, 2); <i class="conum" data-value="3"></i><b>(3)</b>&#x000A;&#x000A;ConsumerRecord&lt;String, String&gt; changeEvent = changeEvents.get(0);&#x000A;assertThat(JsonPath.&lt;Integer&gt; read(changeEvent.key(), "$.id"))&#x000A;  .isEqualTo(1);&#x000A;assertThat(JsonPath.&lt;String&gt; read(changeEvent.value(), "$.op"))&#x000A;  .isEqualTo("r");&#x000A;assertThat(JsonPath.&lt;String&gt; read(changeEvent.value(), "$.after.title"))&#x000A;  .isEqualTo("Learn CDC");&#x000A;&#x000A;changeEvent = changeEvents.get(1);&#x000A;assertThat(JsonPath.&lt;Integer&gt; read(changeEvent.key(), "$.id"))&#x000A;  .isEqualTo(2);&#x000A;assertThat(JsonPath.&lt;String&gt; read(changeEvent.value(), "$.op"))&#x000A;  .isEqualTo("r");&#x000A;assertThat(JsonPath.&lt;String&gt; read(changeEvent.value(), "$.after.title"))&#x000A;  .isEqualTo("Learn Debezium");&#x000A;&#x000A;consumer.unsubscribe();</code></pre> </div> </div> <div class="colist arabic"> <table> <tr> <td><i class="conum" data-value="1"></i><b>1</b></td> <td>Create a table in the Postgres database and insert two records</td> </tr> <tr> <td><i class="conum" data-value="2"></i><b>2</b></td> <td>Register an instance of the Debezium Postgres connector</td> </tr> <tr> <td><i class="conum" data-value="3"></i><b>3</b></td> <td>Read two records from the change event topic in Kafka and assert their attributes</td> </tr> </table> </div> <div class="paragraph"> <p>Note how Debezium&#8217;s Testcontainers support allows to seed the connector configuration from the database container, avoiding the need to give the database connection properties explicitly. Only the unique <code>database.server.name</code> must be given, and of course you could apply other configuration options such as table or column filters, SMTs and more.</p> </div> <div class="paragraph"> <p>The source code for the <code>drain()</code> method for reading a given number of records from a Kafka topic is omitted for the sake of brevity. You can <a href="https://github.com/debezium/debezium-examples/blob/master/testcontainers/src/test/java/io/debezium/examples/testcontainers/DebeziumContainerTest.java#L125-L138">find it</a> in the full example on GitHub.</p> </div> <div class="paragraph"> <p><a href="https://github.com/json-path/JsonPath">JsonPath-based</a> assertions come in handy for asserting the attributes of the expecting data change events, but of course you could also use any other JSON API for the job. When using Apache Avro instead of JSON as a serialization format, you&#8217;d have to use the Avro APIs instead.</p> </div> </div> </div> <div class="sect1"> <h2 id="wrap_up"><a class="anchor" href="#wrap_up"></a>Wrap-Up</h2> <div class="sectionbody"> <div class="paragraph"> <p>Testcontainers and Debezium&#8217;s support for it make it fairly easy to write automated integration tests for your CDC set-up.</p> </div> <div class="paragraph"> <p>The testing approach discussed in this post could be expanded in multiple ways. E.g. it might be desirable to put your connector configuration under revision control (so you can manage and track any configuration changes) and drive the test using these configuration files. You also might take things one step further and test your entire data streaming pipeline. To do so, you&#8217;d have to deploy not only the Debezium connector(s), but also a sink connector, e.g. for your data warehouse or search server. You could then run assertions against the data in those sink systems, ensuring the correctness of your data pipeline end-to-end.</p> </div> <div class="paragraph"> <p>What&#8217;s your take on testing CDC set-ups and pipelines? Let us know in the comments below!</p> </div> </div> </div> <div class="sect1"> <h2 id="about_debezium"><a class="anchor" href="#about_debezium"></a>About Debezium</h2> <div class="sectionbody"> <div class="paragraph"> <p>Debezium is an open source distributed platform that turns your existing databases into event streams, so applications can see and respond almost instantly to each committed row-level change in the databases. Debezium is built on top of <a href="http://kafka.apache.org/">Kafka</a> and provides <a href="http://kafka.apache.org/documentation.html#connect">Kafka Connect</a> compatible connectors that monitor specific database management systems. Debezium records the history of data changes in Kafka logs, so your application can be stopped and restarted at any time and can easily consume all of the events it missed while it was not running, ensuring that all events are processed correctly and completely. Debezium is <a href="/license/">open source</a> under the <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, Version 2.0</a>.</p> </div> </div> </div> <div class="sect1"> <h2 id="get_involved"><a class="anchor" href="#get_involved"></a>Get involved</h2> <div class="sectionbody"> <div class="paragraph"> <p>We hope you find Debezium interesting and useful, and want to give it a try. Follow us on Twitter <a href="https://twitter.com/debezium">@debezium</a>, <a href="https://gitter.im/debezium/user">chat with us on Gitter</a>, or join our <a href="https://groups.google.com/forum/#!forum/debezium">mailing list</a> to talk with the community. All of the code is open source <a href="https://github.com/debezium/">on GitHub</a>, so build the code locally and help us improve ours existing connectors and add even more connectors. If you find problems or have ideas how we can improve Debezium, please let us know or <a href="https://issues.redhat.com/projects/DBZ/issues/">log an issue</a>.</p> </div> </div> </div> </div> </div> <div class="well"> <div class="row"> <div class="col-md-8"> <h2>Gunnar Morling</h2> <p> <span class="bio-size">Gunnar is a software engineer at Red Hat and open-source enthusiast by heart. A long-time Hibernate core team member, he's now the project lead of Debezium. Gunnar is the spec lead for Bean Validation 2.0 (JSR 380). He’s based in Hamburg, Germany.</span> </p> <p class="bio-size"> <a href="https://twitter.com/gunnarmorling"> <i class="icon-twitter"></i> </a> &nbsp; <a href="https://github.com/gunnarmorling"> <i class="icon-github"></i> </a> &nbsp; </p> </div> <div class="col-md-4"> <img alt="" class="img-responsive pull-right portrait" src="/images/gmorling.jpg"> </div> </div> </div> <div class="comments"> <div id="disqus_thread"></div> <script type="text/javascript">
            var disqus_shortname = 'Debezium';
            var disqus_url = "https://debezium.io/blog/2020/03/19/integration-testing-for-change-data-capture-with-testcontainers/";
            var disqus_developer = null;
            var disqus_identifier = null;
            (function() {
              var dsq = document.createElement("script"); dsq.type = "text/javascript"; dsq.async = true;
              dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
              (document.getElementsByTagName("head")[0] || document.getElementsByTagName("body")[0]).appendChild(dsq);
            })();
            </script> <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript=Debezium">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2020 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/documentation/features" title="Features">Features</a> </li> <li> <a href="/documentation/install/stable/" title="Install">Install</a> </li> <li> <a href="/documentation/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/documentation/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/community/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/user" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="/images/Logo-Red_Hat-Sponsored_By-B-Standard-RGB.svg"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
  var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
  var urlSplit = coreUrl.toLowerCase().split(/\//);
  var urlLast = urlSplit[urlSplit.length-1];
  var pageNameString = "";
  var siteName = "";
  var minorSectionIndex = 3
  if (urlLast == "") {
      urlSplit.splice(-1,1);
  }
  if (urlLast.search(/\./) >= 0) {
      if (urlLast == "index.html") {
          urlSplit.splice(-1,1);
      }
      else {
          urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
      }
  }
  siteName = urlSplit[2].split(".")[1];
  s.prop14 = s.eVar27 = siteName || "";
  s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
  s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
  pageNameString = urlSplit.splice(3).join(" | ");
  s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
  s.server = "jboss";
  s.channel = "jboss | community";
  s.prop4 = s.eVar23 = encodeURI(document.URL);
  s.prop21 = s.eVar18 = coreUrl;
  s.prop2 = s.eVar22 = "en";
  s.prop3 = s.eVar19 = "us";
  //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
  if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
  //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
</script> <script type="text/javascript">
try {
var pageTracker = _gat._getTracker("UA-10656779-1");
pageTracker._trackPageview();
} catch(err) {}</script> <script>
 (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
 
ga('create', 'UA-76464546-1', 'auto');
ga('send', 'pageview');
ga('set', 'anonymizeIp', true);
ga('require', 'linkid', 'linkid.js');

</script> </div> </body> </html>