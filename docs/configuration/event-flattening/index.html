<!DOCTYPE html> <html lang="en"> <head> <title>CDC Event Flattening Â· Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="http://static.jboss.org/theme/css/bootstrap-community/3.2.0.1/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="http://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="http://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="http://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="http://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="http://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
      @media (min-width: 980px) {
        .banner { background-image: url(http://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
      }
      @media (max-width: 979px) {
        .banner { background-image: url(http://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
      }
      @media (max-width: 650px) {
        .banner { width: 100%; margin: 0px auto; }
      }
      @media (max-width: 450px) {
        .banner { height: 90px; }
      }
    </style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
      hljs.initHighlightingOnLoad();
    </script> <script src="http://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
      /* adjusting the vertical spacing for when a stickynav is engaged */
      .breadcrumb-fixed > .active {
        color: #8c8f91;
      }
      .breadcrumb-fixed {
        margin: 70px 0 10px;
        padding: 8px 15px;
        margin-bottom: 20px;
        list-style: none;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      
      .breadcrumb-fixed > li {
        display: inline-block;
      }
    </style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="http://www.jboss.org/projects/about"></a> <a class="rhlogo" href="http://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> Debezium </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/docs/faq">FAQ</a></li> <li class="active"><a href="/docs">DOCS</a></li> <li class=""><a href="/community">COMMUNITY</a></li> <li class=""><a href="/blog">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="col-sm-3" id="leftdocnav"> <div class="panel-group" id="accordion1"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse1"> Get Started </a> </h4> </div> <div class="collapse panel-collapse" id="collapse1"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/concepts">Concepts</a></li> <li class="list-group-item"><a href="/docs/tutorial">Tutorial</a></li> <li class="list-group-item"><a href="/docs/install">Installing Debezium</a></li> <li class="list-group-item"><a href="/docs/embedded">Embedding Debezium</a></li> <li class="list-group-item"><a href="/docs/openshift">Running on OpenShift</a></li> <li class="list-group-item"><a href="/docs/monitoring">Monitoring Debezium</a></li> <li class="list-group-item"><a href="/docs/releases">Releases</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion2"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse2"> Configuration </a> </h4> </div> <div class="collapse in panel-collapse" id="collapse2"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/configuration/logging">Logging</a></li> <li class="list-group-item"><a href="/docs/configuration/avro">Avro Serialization</a></li> <li class="list-group-item"><a href="/docs/configuration/topic-routing">Topic Routing</a></li> <li class="active list-group-item"><a href="/docs/configuration/event-flattening">CDC Event Flattening</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion3"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse3"> Connectors </a> </h4> </div> <div class="collapse panel-collapse" id="collapse3"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/connectors/mysql">MySQL</a></li> <li class="list-group-item"><a href="/docs/connectors/mongodb">MongoDB</a></li> <li class="list-group-item"><a href="/docs/connectors/postgresql">PostgreSQL</a></li> <li class="list-group-item"><a href="/docs/connectors/oracle">Oracle</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion4"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse4"> How it works </a> </h4> </div> <div class="collapse panel-collapse" id="collapse4"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/faq">FAQ</a></li> <li class="list-group-item"><a href="/docs/architecture">Debezium Architecture</a></li> <li class="list-group-item"><a href="/docs/features">Debezium Features</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion5"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse5"> Contribute </a> </h4> </div> <div class="collapse panel-collapse" id="collapse5"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/contribute">Contribute to Debezium</a></li> <li class="list-group-item"><a href="/docs/code-of-conduct">Code of Conduct</a></li> <li class="list-group-item"> <a href="https://twitter.com/debezium">Twitter</a> </li> <li class="list-group-item"> <a href="https://gitter.im/debezium/dev">Chat</a> </li> <li class="list-group-item"> <a href="https://github.com/debezium/">Code</a> </li> <li class="list-group-item"> <a href="https://issues.jboss.org/projects/DBZ/issues">Issues</a> </li> </ul> </div></div> </div> </div> </div> <div class="col-sm-9" id="maincol"> <h1 class="title"> CDC Event Flattening </h1> <div id="preamble"> <div class="sectionbody"> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>This SMT is available since Debezium version 0.6.0.</p> </div> </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>This SMT is supported only for the SQL database connectors, it does not work with the MongoDB connector.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>Debezium generates a data change in a form of a complex message structure. The message consists of three parts:</p> </div> <div class="ulist"> <ul> <li> <p>operation and metadata</p> </li> <li> <p>the row data before change</p> </li> <li> <p>the row data after change</p> </li> </ul> </div> <div class="paragraph"> <p>E.g. the general message structure for an <code>update</code> change looks like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-json" data-lang="json">{&#x000A;	"op": "u",&#x000A;	"source": {&#x000A;		...&#x000A;	},&#x000A;	"ts_ms" : "...",&#x000A;	"before" : {&#x000A;		"field1" : "oldvalue1",&#x000A;		"field2" : "oldvalue2"&#x000A;	},&#x000A;	"after" : {&#x000A;		"field1" : "newvalue1",&#x000A;		"field2" : "newvalue2"&#x000A;	}&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>More details about the message structure are provided in <a href="../../connectors">the documentation for each connector</a>.</p> </div> <div class="paragraph"> <p>This format allows the user to get most information about changes happening in the system. The downside of using the complex format is that other connectors or other parts of the Kafka ecosystem usually expect the data in a simple message format that can generally be described like so:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-json" data-lang="json">{&#x000A;	"field1" : "newvalue1",&#x000A;	"field2" : "newvalue2"&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>Debezium provides <a href="https://kafka.apache.org/documentation/#connect_transforms">a single message transformation</a> that crosses the bridge between the complex and simple formats, the <a href="https://github.com/debezium/debezium/blob/master/debezium-core/src/main/java/io/debezium/transforms/UnwrapFromEnvelope.java">UnwrapFromEnvelope</a> SMT.</p> </div> <div class="paragraph"> <p>The SMT provides two main functions. It</p> </div> <div class="ulist"> <ul> <li> <p>extracts the <code>after</code> field from change events and replaces the original event just with this part</p> </li> <li> <p>optionally filters delete and tombstone records, as per the capabilities and requirements of downstream consumers</p> </li> </ul> </div> <div class="paragraph"> <p>The SMT can be applied either to a source connector (Debezium) or a sink connector. We generally recommend to apply the transformation on the sink side as it means that the messages stored in Apache Kafka will contain the whole context. The final decision depends on use case for each user.</p> </div> </div> </div> <div class="sect1"> <h2 id="_configuration">Configuration</h2> <div class="sectionbody"> <div class="paragraph"> <p>The configuration is a part of source/sink task connector and is expressed in a set of properties:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code>transforms=unwrap,...&#x000A;transforms.unwrap.type=io.debezium.transforms.UnwrapFromEnvelope&#x000A;transforms.unwrap.drop.tombstones=false</code></pre> </div> </div> <div class="sect2"> <h3 id="_record_filtering_for_delete_records">Record filtering for delete records</h3> <div class="paragraph"> <p>The SMT provides a special handling for events that signals <code>delete</code> operation. When a <code>DELETE</code> is executed on a datasource then Debezium generates two records:</p> </div> <div class="ulist"> <ul> <li> <p>a record with <code>d</code> operation that contains only old row data</p> </li> <li> <p>a record with <code>null</code> value and the same key. This record serves as a tombstone marker for Apache Kafka for <a href="https://kafka.apache.org/documentation/#compaction">a log compaction process</a>.</p> </li> </ul> </div> <div class="paragraph"> <p>Upon processing these two records, the SMT turns the <code>d</code> record into another tombstone. The user can configure if both records, only one of them or none is filtered out.</p> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>SMT by default filters out <strong>BOTH</strong> delete records as the widely used sink connectors like JDBC and ElasticSearch do not support handling of tombstone records.</p> </div> </td> </tr> </table> </div> </div> </div> </div> <div class="sect1"> <h2 id="_configuration_options">Configuration options</h2> <div class="sectionbody"> <table class="tableblock frame-all grid-all spread table table-bordered table-striped"> <colgroup> <col style="width: 35%;"> <col style="width: 10%;"> <col style="width: 55%;"> </colgroup> <thead> <tr> <th class="tableblock halign-left valign-top">Property</th> <th class="tableblock halign-left valign-top">Default</th> <th class="tableblock halign-left valign-top">Description</th> </tr> </thead> <tfoot> <tr> <td class="tableblock halign-left valign-top"><div><div class="paragraph"> <p><code>drop.deletes</code></p> </div></div></td> <td class="tableblock halign-left valign-top"><div><div class="paragraph"> <p><code>true</code></p> </div></div></td> <td class="tableblock halign-left valign-top"><div><div class="paragraph"> <p>The SMT removes the <code>d</code> record generated by Debezium (and converted to tombstone by the SMT) from the stream.</p> </div></div></td> </tr> </tfoot> <tbody> <tr> <td class="tableblock halign-left valign-top"><div><div class="paragraph"> <p><code>drop.tombstones</code></p> </div></div></td> <td class="tableblock halign-left valign-top"><div><div class="paragraph"> <p><code>true</code></p> </div></div></td> <td class="tableblock halign-left valign-top"><div><div class="paragraph"> <p>The SMT removes the tombstone generated by Debezium from the stream.</p> </div></div></td> </tr> </tbody> </table> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2018 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="http://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="http://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/docs/features" title="Features">Features</a> </li> <li> <a href="/docs/install" title="Install">Install</a> </li> <li> <a href="/docs/manage" title="Manage">Manage</a> </li> <li> <a href="/docs/architecture" title="Architecture">Architecture</a> </li> <li> <a href="/docs/faq" title="FAQ">FAQ</a> </li> <li> <a href="/docs/contribute" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/dev" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="http://static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="http://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.1/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='http://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='http://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
        var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
        var urlSplit = coreUrl.toLowerCase().split(/\//);
        var urlLast = urlSplit[urlSplit.length-1];
        var pageNameString = "";
        var siteName = "";
        var minorSectionIndex = 3
        if (urlLast == "") {
            urlSplit.splice(-1,1);
        }
        if (urlLast.search(/\./) >= 0) {
            if (urlLast == "index.html") {
                urlSplit.splice(-1,1);
            }
            else {
                urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
            }
        }
        siteName = urlSplit[2].split(".")[1];
        s.prop14 = s.eVar27 = siteName || "";
        s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
        s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
        pageNameString = urlSplit.splice(3).join(" | ");
        s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
        s.server = "jboss";
        s.channel = "jboss | community";
        s.prop4 = s.eVar23 = encodeURI(document.URL);
        s.prop21 = s.eVar18 = coreUrl;
        s.prop2 = s.eVar22 = "en";
        s.prop3 = s.eVar19 = "us";
        //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
        if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
        //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      </script> <script type="text/javascript">
      try {
      var pageTracker = _gat._getTracker("UA-10656779-1");
      pageTracker._trackPageview();
      } catch(err) {}</script> <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      
                          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      
                          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      
                          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       
      ga('create', 'UA-76464546-1', 'auto');
      ga('send', 'pageview');
      ga('set', 'anonymizeIp', true);
      ga('require', 'linkid', 'linkid.js');
      
      </script> </div> </body> </html>