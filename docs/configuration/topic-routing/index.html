<!DOCTYPE html> <html lang="en"> <head> <title>Topic Routing Â· Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="https://static.jboss.org/theme/css/bootstrap-community/3.2.0.2/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="https://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="https://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="https://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="https://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="https://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="https://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
      @media (min-width: 980px) {
        .banner { background-image: url(https://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
      }
      @media (max-width: 979px) {
        .banner { background-image: url(https://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
      }
      @media (max-width: 650px) {
        .banner { width: 100%; margin: 0px auto; }
      }
      @media (max-width: 450px) {
        .banner { height: 90px; }
      }
    </style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
      hljs.initHighlightingOnLoad();
    </script> <script src="https://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
      /* adjusting the vertical spacing for when a stickynav is engaged */
      .breadcrumb-fixed > .active {
        color: #8c8f91;
      }
      .breadcrumb-fixed {
        margin: 70px 0 10px;
        padding: 8px 15px;
        margin-bottom: 20px;
        list-style: none;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      
      .breadcrumb-fixed > li {
        display: inline-block;
      }
    </style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="https://www.jboss.org/projects/about"></a> <a class="rhlogo" href="https://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> Debezium </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/docs/faq/">FAQ</a></li> <li class="active"><a href="/docs/">DOCS</a></li> <li class=""><a href="/community/">COMMUNITY</a></li> <li class=""><a href="/blog/">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="col-sm-3" id="leftdocnav"> <div class="panel-group" id="accordion1"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse1"> Get Started </a> </h4> </div> <div class="collapse panel-collapse" id="collapse1"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/concepts/">Concepts</a></li> <li class="list-group-item"><a href="/docs/tutorial/">Tutorial</a></li> <li class="list-group-item"><a href="/docs/install/">Installing Debezium</a></li> <li class="list-group-item"><a href="/docs/embedded/">Embedding Debezium</a></li> <li class="list-group-item"><a href="/docs/openshift/">Running on OpenShift</a></li> <li class="list-group-item"><a href="/docs/monitoring/">Monitoring Debezium</a></li> <li class="list-group-item"><a href="/docs/online-resources/">Resources on the Web</a></li> <li class="list-group-item"><a href="/docs/releases/">Releases</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion2"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse2"> Configuration </a> </h4> </div> <div class="collapse in panel-collapse" id="collapse2"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/configuration/logging/">Logging</a></li> <li class="list-group-item"><a href="/docs/configuration/avro/">Avro Serialization</a></li> <li class="active list-group-item"><a href="/docs/configuration/topic-routing/">Topic Routing</a></li> <li class="list-group-item"><a href="/docs/configuration/event-flattening/">CDC Event Flattening</a></li> <li class="list-group-item"><a href="/docs/configuration/mongodb-event-flattening/">MongoDB CDC Event Flattening</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion3"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse3"> Connectors </a> </h4> </div> <div class="collapse panel-collapse" id="collapse3"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/connectors/mysql/">MySQL</a></li> <li class="list-group-item"><a href="/docs/connectors/mongodb/">MongoDB</a></li> <li class="list-group-item"><a href="/docs/connectors/postgresql/">PostgreSQL</a></li> <li class="list-group-item"><a href="/docs/connectors/oracle/">Oracle</a></li> <li class="list-group-item"><a href="/docs/connectors/sqlserver/">SQL Server</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion4"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse4"> How it works </a> </h4> </div> <div class="collapse panel-collapse" id="collapse4"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/faq/">FAQ</a></li> <li class="list-group-item"><a href="/docs/architecture/">Debezium Architecture</a></li> <li class="list-group-item"><a href="/docs/features/">Debezium Features</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion5"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse5"> Contribute </a> </h4> </div> <div class="collapse panel-collapse" id="collapse5"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/contribute/">Contribute to Debezium</a></li> <li class="list-group-item"><a href="/docs/code-of-conduct/">Code of Conduct</a></li> <li class="list-group-item"> <a href="https://twitter.com/debezium">Twitter</a> </li> <li class="list-group-item"> <a href="https://gitter.im/debezium/dev">Chat</a> </li> <li class="list-group-item"> <a href="https://github.com/debezium/">Code</a> </li> <li class="list-group-item"> <a href="https://issues.jboss.org/projects/DBZ/issues">Issues</a> </li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion6"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a href="/docs/roadmap/">Roadmap</a> </h4> </div> </div> </div> </div> <div class="col-sm-9" id="maincol"> <h1 class="title"> Topic Routing </h1> <div id="preamble"> <div class="sectionbody"> <div class="paragraph"> <p>Debezium enables you to re-route the emitted change before the message reaches the converter using a single message transformation, or <a href="https://kafka.apache.org/documentation/#connect_transforms">SMT</a>. The SMT provided by Debezium enables you to rewrite the topic and the key according to a regular expression and a replacement pattern, configurable per instance of Debezium.</p> </div> <div class="paragraph"> <p>The implementation does not care about the sanity of the change, this is in the responsibility of the user.</p> </div> </div> </div> <div class="sect1"> <h2 id="use_cases"><a class="anchor" href="#use_cases"></a>Use-Cases</h2> <div class="sectionbody"> <div class="sect2"> <h3 id="logical_tables"><a class="anchor" href="#logical_tables"></a>Logical Tables</h3> <div class="paragraph"> <p>A logical table consists of one or more physical tables with the same table structure. A common use case is sharding, where for example two physical tables <code>db_shard1.my_table</code> and <code>db_shard2.my_table</code> together form one logical table.</p> </div> <div class="paragraph"> <p>Typically the physical tables share the same schema.</p> </div> <div class="paragraph"> <p>Normally, Debezium connectors send each change event to a topic that is named by the database and table. But since the sharded tables have the same schema, we&#8217;d instead like to re-route each change event to a topic named by the <em>logical</em> table name. This way, all changes events for any of the shards all go to the same topic.</p> </div> <div class="paragraph"> <p>What happens if each physical table has a primary key that is only unique within that table? In this case, a row in shard 1 can have the same primary key as a row in shard 2. Since Debezium events are keyed by the columns that make up the primary key, the events for that row in shard 1 would have the same key as the row in shard 2, even though globally they are different rows. So, in addition to changing the topic name, we may also want to <em>modify the event key</em> to add a field that makes the key globally unique.</p> </div> <div class="paragraph"> <p>This SMT lets you specify how you want to choose the new topic name and then specify how to modify the change event key to ensure it is globally unique.</p> </div> </div> </div> </div> <div class="sect1"> <h2 id="topic_names"><a class="anchor" href="#topic_names"></a>Topic Names</h2> <div class="sectionbody"> <div class="paragraph"> <p>Below is an example for a configuration which replaces a part of the table in the topic with another string, allowing two tables to emit changes to the same topic:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code>transforms=Reroute&#x000A;transforms.Reroute.type=io.debezium.transforms.ByLogicalTableRouter&#x000A;transforms.Reroute.topic.regex=(.*)customers_shard(.*)&#x000A;transforms.Reroute.topic.replacement=$1customers_all_shards</code></pre> </div> </div> <div class="paragraph"> <p>The configuration above will match topics such as <code>myserver.mydb.customers_shard1</code>, <code>myserver.mydb.customers_shard2</code> etc. and replace it with <code>myserver.mydb.customers_all_shards.</code></p> </div> </div> </div> <div class="sect1"> <h2 id="key_fields"><a class="anchor" href="#key_fields"></a>Key Fields</h2> <div class="sectionbody"> <div class="paragraph"> <p>To address the concern of uniqueness across all the original tables discussed above, one more field for identifying the original (physical) table is inserted into the key structure of the change events. By default, this field is named <code><em>dbz</em>physicalTableIdentifier</code> and has the original topic name as its value.</p> </div> <div class="paragraph"> <p>If needed, another <em>field name</em> can be chosen by means of the <code>key.field.name</code> property (obviously you&#8217;ll want to choose a field name that doesn&#8217;t clash with existing primary key fields). For example the following configuration will use the name <code>shard_id</code> for the key field:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code>...&#x000A;transforms.Reroute.key.field.name=shard_id&#x000A;...</code></pre> </div> </div> <div class="paragraph"> <p>The <em>value</em> of the field can be adjusted via the <code>key.field.regex</code> and <code>key.field.replacement</code> properties. The former allows you to define a regular expression that will be applied to the original topic name to capture one or more groups of characters. The latter lets you specify an expression that defines the value for the field in terms of those captured groups. For example:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code>...&#x000A;transforms.Reroute.key.field.regex=(.*)customers_shard(.*)&#x000A;transforms.Reroute.key.field.replacement=$2</code></pre> </div> </div> <div class="paragraph"> <p>This will apply the given regular expression to original topic names and use the second capturing group as value for the key field. Assuming the source topics are named <code>myserver.mydb.customers_shard1</code>, <code>myserver.mydb.customers_shard2</code> etc., the key field&#8217;s values would be <code>1</code>, <code>2</code> etc.</p> </div> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2018 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="https://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="https://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/docs/features/" title="Features">Features</a> </li> <li> <a href="/docs/install/" title="Install">Install</a> </li> <li> <a href="/docs/manage/" title="Manage">Manage</a> </li> <li> <a href="/docs/architecture/" title="Architecture">Architecture</a> </li> <li> <a href="/docs/faq/" title="FAQ">FAQ</a> </li> <li> <a href="/docs/contribute/" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/dev" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="https://www.redhat.com/"><img src="https://static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="https://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.2/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='https://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
        var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
        var urlSplit = coreUrl.toLowerCase().split(/\//);
        var urlLast = urlSplit[urlSplit.length-1];
        var pageNameString = "";
        var siteName = "";
        var minorSectionIndex = 3
        if (urlLast == "") {
            urlSplit.splice(-1,1);
        }
        if (urlLast.search(/\./) >= 0) {
            if (urlLast == "index.html") {
                urlSplit.splice(-1,1);
            }
            else {
                urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
            }
        }
        siteName = urlSplit[2].split(".")[1];
        s.prop14 = s.eVar27 = siteName || "";
        s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
        s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
        pageNameString = urlSplit.splice(3).join(" | ");
        s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
        s.server = "jboss";
        s.channel = "jboss | community";
        s.prop4 = s.eVar23 = encodeURI(document.URL);
        s.prop21 = s.eVar18 = coreUrl;
        s.prop2 = s.eVar22 = "en";
        s.prop3 = s.eVar19 = "us";
        //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
        if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
        //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      </script> <script type="text/javascript">
      try {
      var pageTracker = _gat._getTracker("UA-10656779-1");
      pageTracker._trackPageview();
      } catch(err) {}</script> <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       
      ga('create', 'UA-76464546-1', 'auto');
      ga('send', 'pageview');
      ga('set', 'anonymizeIp', true);
      ga('require', 'linkid', 'linkid.js');
      
      </script> </div> </body> </html>