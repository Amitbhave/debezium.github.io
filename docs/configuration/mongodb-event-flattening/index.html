<!DOCTYPE html> <html lang="en"> <head> <title>MongoDB CDC Event Flattening Â· Debezium</title> <meta charset="utf-8"> <meta content="width=device-width, initial-scale=1.0" name="viewport"> <meta content="" name="description"> <meta content="" name="author"> <link href="http://static.jboss.org/theme/css/bootstrap-community/3.2.0.1/bootstrap-community.min.css" media="screen" rel="stylesheet"> <!--[if lt IE 9]><script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script><![endif]--> <link href="http://static.jboss.org/example/images/favicon.ico" rel="shortcut icon"> <link href="http://static.jboss.org/example/images/apple-touch-icon-144x144-precomposed.png" rel="apple-touch-icon-precomposed" sizes="144x144"> <link href="http://static.jboss.org/example/images/apple-touch-icon-114x114-precomposed.png" rel="apple-touch-icon-precomposed" sizes="114x114"> <link href="http://static.jboss.org/example/images/apple-touch-icon-72x72-precomposed.png" rel="apple-touch-icon-precomposed" sizes="72x72"> <link href="http://static.jboss.org/example/images/apple-touch-icon-precomposed.png" rel="apple-touch-icon-precomposed"> <link href="/stylesheets/debezium.css" rel="stylesheet" type="text/css"> <style>
      @media (min-width: 980px) {
        .banner { background-image: url(http://static.jboss.org/example/images/debezium-banner-1180px.png); height: 110px;  }
      }
      @media (max-width: 979px) {
        .banner { background-image: url(http://static.jboss.org/example/images/debezium-logo.png); background-repeat:no-repeat; background-position: center bottom; height: 60px; }
      }
      @media (max-width: 650px) {
        .banner { width: 100%; margin: 0px auto; }
      }
      @media (max-width: 450px) {
        .banner { height: 90px; }
      }
    </style> <link href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/styles/default.min.css" rel="stylesheet"> <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.3.0/highlight.min.js"></script> <script>
      hljs.initHighlightingOnLoad();
    </script> <script src="http://static.jboss.org/theme/js/libs/jquery/jquery-1.9.1.min.js"></script> <style>
      /* adjusting the vertical spacing for when a stickynav is engaged */
      .breadcrumb-fixed > .active {
        color: #8c8f91;
      }
      .breadcrumb-fixed {
        margin: 70px 0 10px;
        padding: 8px 15px;
        margin-bottom: 20px;
        list-style: none;
        background-color: #f5f5f5;
        border-radius: 4px;
      }
      
      .breadcrumb-fixed > li {
        display: inline-block;
      }
    </style> </head> <body> <div id="rhbar"> <a class="jbdevlogo" href="http://www.jboss.org/projects/about"></a> <a class="rhlogo" href="http://www.redhat.com/"></a> </div> <div id=""> <ul class="visuallyhidden" id="top"> <li> <a accesskey="n" href="#nav" title="Skip to navigation">Skip to navigation</a> </li> <li> <a accesskey="c" href="#page" title="Skip to content">Skip to content</a> </li> </ul> <div class="container" id="content"> <div class="navbar navbar-inverse navbar-fix"> <div class="container-fluid"> <div class="navbar-header"> <button class="navbar-toggle collapsed" data-target="#navbar-1" data-toggle="collapse"> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/"> Debezium </a> </div> <div class="collapse navbar-collapse" id="navbar-1"> <ul class="nav navbar-nav pull-right"> <li class=""><a href="/docs/faq">FAQ</a></li> <li class="active"><a href="/docs">DOCS</a></li> <li class=""><a href="/community">COMMUNITY</a></li> <li class=""><a href="/blog">BLOG</a></li> </ul> </div> </div> </div> <div id="equalHeightsLayout"> <div class="col-sm-3" id="leftdocnav"> <div class="panel-group" id="accordion1"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse1"> Get Started </a> </h4> </div> <div class="collapse panel-collapse" id="collapse1"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/concepts">Concepts</a></li> <li class="list-group-item"><a href="/docs/tutorial">Tutorial</a></li> <li class="list-group-item"><a href="/docs/install">Installing Debezium</a></li> <li class="list-group-item"><a href="/docs/embedded">Embedding Debezium</a></li> <li class="list-group-item"><a href="/docs/openshift">Running on OpenShift</a></li> <li class="list-group-item"><a href="/docs/monitoring">Monitoring Debezium</a></li> <li class="list-group-item"><a href="/docs/releases">Releases</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion2"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse2"> Configuration </a> </h4> </div> <div class="collapse in panel-collapse" id="collapse2"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/configuration/logging">Logging</a></li> <li class="list-group-item"><a href="/docs/configuration/avro">Avro Serialization</a></li> <li class="list-group-item"><a href="/docs/configuration/topic-routing">Topic Routing</a></li> <li class="list-group-item"><a href="/docs/configuration/event-flattening">CDC Event Flattening</a></li> <li class="active list-group-item"><a href="/docs/configuration/mongodb-event-flattening">MongoDB CDC Event Flattening</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion3"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse3"> Connectors </a> </h4> </div> <div class="collapse panel-collapse" id="collapse3"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/connectors/mysql">MySQL</a></li> <li class="list-group-item"><a href="/docs/connectors/mongodb">MongoDB</a></li> <li class="list-group-item"><a href="/docs/connectors/postgresql">PostgreSQL</a></li> <li class="list-group-item"><a href="/docs/connectors/oracle">Oracle</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion4"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse4"> How it works </a> </h4> </div> <div class="collapse panel-collapse" id="collapse4"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/faq">FAQ</a></li> <li class="list-group-item"><a href="/docs/architecture">Debezium Architecture</a></li> <li class="list-group-item"><a href="/docs/features">Debezium Features</a></li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion5"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a class="accordion-toggle" data-parent="#accordion1,#accordion2,#accordion3,#accordion4,#accordion5" data-toggle="collapse" href="#collapse5"> Contribute </a> </h4> </div> <div class="collapse panel-collapse" id="collapse5"><div class="panel-body"> <ul class="list-group"> <li class="list-group-item"><a href="/docs/contribute">Contribute to Debezium</a></li> <li class="list-group-item"><a href="/docs/code-of-conduct">Code of Conduct</a></li> <li class="list-group-item"> <a href="https://twitter.com/debezium">Twitter</a> </li> <li class="list-group-item"> <a href="https://gitter.im/debezium/dev">Chat</a> </li> <li class="list-group-item"> <a href="https://github.com/debezium/">Code</a> </li> <li class="list-group-item"> <a href="https://issues.jboss.org/projects/DBZ/issues">Issues</a> </li> </ul> </div></div> </div> </div> <div class="panel-group" id="accordion6"> <div class="panel panel-docnav"> <div class="panel-heading"> <h4 class="panel-title"> <a href="/docs/roadmap">Roadmap</a> </h4> </div> </div> </div> </div> <div class="col-sm-9" id="maincol"> <h1 class="title"> MongoDB CDC Event Flattening </h1> <div id="preamble"> <div class="sectionbody"> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>This single message transformation (SMT) is available since Debezium version 0.7.2. It is under active development right now, so the emitted message structure or other details may still change as development progresses. Please see below for a descriptions of known limitations of this transformation.</p> </div> </td> </tr> </table> </div> <div class="admonitionblock note"> <table> <tr> <td class="icon"> <i class="fa icon-note" title="Note"></i> </td> <td class="content"> <div class="paragraph"> <p>This SMT is supported only for the MongoDB connector.</p> </div> </td> </tr> </table> </div> <div class="paragraph"> <p>The Debezium MongoDB connector generates the data in a form of a complex message structure. The message consists of two parts:</p> </div> <div class="ulist"> <ul> <li> <p>operation and metadata</p> </li> <li> <p>for inserts, the row data after the insert has been executed; for updates a patch element describing the altered fields</p> </li> </ul> </div> <div class="paragraph"> <p>The <code>after</code> and <code>patch</code> elements are Strings containing JSON representations of the inserted/altered data. E.g. the general message structure for a insert event looks like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{&#x000A;  "op": "r",&#x000A;  "after": "{\"field1\":newvalue1,\"field2\":\"newvalue1\"}",&#x000A;  "source": { ... }&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>More details about the message structure are provided in <a href="/docs/connectors/mongodb/">the documentation</a> of the MongoDB connector.</p> </div> <div class="paragraph"> <p>While this structure is a good fit to represent changes to MongoDB&#8217;s schemaless collections, it&#8217;s not understood by existing sink connectors as for instance the Confluent JDBC sink connector.</p> </div> <div class="paragraph"> <p>Therefore Debezium provides a <a href="https://kafka.apache.org/documentation/#connect_transforms">a single message transformation</a> (SMT) which converts the <code>after</code>/<code>patch</code> information from the MongoDB CDC events into a structure suitable for consumption by existing sink connectors. To do so, the SMT parses the JSON strings and reconstructs properly typed Kafka Connect (comprising the correct message payload and schema) records from that, which then can be consumed by connectors such as the JDBC sink connector.</p> </div> <div class="paragraph"> <p>Using JSON as visualization of the emitted record structure, the event from above would like this:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{&#x000A;	"field1" : "newvalue1",&#x000A;	"field2" : "newvalue2"&#x000A;}</code></pre> </div> </div> <div class="paragraph"> <p>The SMT should be applied on a sink connector.</p> </div> </div> </div> <div class="sect1"> <h2 id="configuration"><a class="anchor" href="#configuration"></a>Configuration</h2> <div class="sectionbody"> <div class="paragraph"> <p>The configuration is a part of sink task connector and is expressed in a set of properties:</p> </div> <div class="listingblock"> <div class="content"> <pre class="highlightjs highlight"><code>transforms=unwrap,...&#x000A;transforms.unwrap.type=io.debezium.connector.mongodb.transforms.UnwrapFromMongoDbEnvelope</code></pre> </div> </div> </div> </div> <div class="sect1"> <h2 id="known_limitations"><a class="anchor" href="#known_limitations"></a>Known limitations</h2> <div class="sectionbody"> <div class="ulist"> <ul> <li> <p>Feeding data changes from a schemaless store such as MongoDB to strictly schema-based datastores such as a relational database can by definition work within certain limits only. Specifically, all fields of documents within one collection with the same name must be of the same type. Otherwise, no consistent column definition can be derived in the target database.</p> </li> <li> <p>Arrays will be restored in the emitted Kafka Connect record correctly, but they are not supported my sink connector just expecting a "flat" message structure.</p> </li> <li> <p>Currently it&#8217;s not possible to drop deletes and tomb stone events. This requirement is tracked as <a href="https://issues.jboss.org/browse/DBZ-563">DBZ-563</a>.</p> </li> <li> <p>It&#8217;s planned to optionally flatten nested structures (which are no arrays). That way a complex field such as <code>_id : { comp: 32, cust: NumberLong("1008") }</code> would be represented as <code>id_comp : 32, id_cust: 1008</code> in the emitted message. This requirement is tracked as <a href="https://issues.jboss.org/browse/DBZ-561">DBZ-561</a>.</p> </li> </ul> </div> </div> </div> </div> </div> </div> <footer class="container"> <div class="row"> <div class="col-md-5 col-md-offset-1"> <h4>Debezium</h4> <p> &#169; 2018 Debezium Community <br> <br> <i class="icon-fire"></i> Mixed with <a href="http://twitter.github.com/bootstrap">Bootstrap</a>, baked by <a href="http://awestruct.org">Awestruct</a>. <br> <i class="icon-flag"></i> Website and docs licensed under <a href="http://creativecommons.org/licenses/by/3.0/">CC BY 3.0</a>. <br> <i class="icon-flag-alt"></i> Code released under <a href="http://www.apache.org/licenses/LICENSE-2.0.html">Apache License, v2.0</a>. <br> <i class="icon-file-alt"></i> <a href="http://www.redhat.com/legal/legal_statement.html" title="Terms">Terms</a> | <a href="http://www.redhat.com/legal/privacy_statement.html" title="Privacy Policy">Privacy</a> </p> </div> <div class="col-md-3"> <h4>Documentation</h4> <ul class="list-unstyled"> <li> <a href="/docs/features" title="Features">Features</a> </li> <li> <a href="/docs/install" title="Install">Install</a> </li> <li> <a href="/docs/manage" title="Manage">Manage</a> </li> <li> <a href="/docs/architecture" title="Architecture">Architecture</a> </li> <li> <a href="/docs/faq" title="FAQ">FAQ</a> </li> <li> <a href="/docs/contribute" title="Contribute">Contribute</a> </li> </ul> </div> <div class="col-md-3"> <h4>Connect</h4> <ul class="list-unstyled"> <li> <a href="/blog" title="Blog">Blog</a> </li> <li> <a href="http://twitter.com/debezium" title="Twitter">Twitter</a> </li> <li> <a href="http://github.com/debezium" title="GitHub">GitHub</a> </li> <li> <a href="https://gitter.im/debezium/dev" title="Chat">Chat</a> </li> <li> <a href="https://groups.google.com/forum/#!forum/debezium" title="Google Groups">Google Groups</a> </li> <li> <a href="http://stackoverflow.com/questions/tagged/debezium" title="StackOverflow">StackOverflow</a> </li> </ul> </div> </div> </footer> <div class="container" id="companyfooter"> <div class="redhatlogo"> <div id="logospacer"></div> <a href="http://www.redhat.com/"><img src="http://static.jboss.org/theme/images/common/redhat_logo.png"></a> </div> </div> <span class="backToTop"> <a href="#top">back to top</a> </span> <script src="http://static.jboss.org/theme/js/libs/bootstrap-community/3.2.0.1/bootstrap-community.min.js"></script> <script type='text/javascript' language='JavaScript' src='http://www.redhat.com/j/elqNow/elqCfg.js'></script> <script type='text/javascript' language='JavaScript' src='http://www.redhat.com/j/elqNow/elqImg.js'></script> <div id="oTags"> <script type="text/javascript" src="//www.redhat.com/j/s_code.js"></script> <script type="text/javascript"><!--
        var coreUrl = encodeURI(document.URL.split("?")[0]).replace(/-/g," ");
        var urlSplit = coreUrl.toLowerCase().split(/\//);
        var urlLast = urlSplit[urlSplit.length-1];
        var pageNameString = "";
        var siteName = "";
        var minorSectionIndex = 3
        if (urlLast == "") {
            urlSplit.splice(-1,1);
        }
        if (urlLast.search(/\./) >= 0) {
            if (urlLast == "index.html") {
                urlSplit.splice(-1,1);
            }
            else {
                urlSplit[urlSplit.length-1] = urlLast.split(".").splice(0,1);
            }
        }
        siteName = urlSplit[2].split(".")[1];
        s.prop14 = s.eVar27 = siteName || "";
        s.prop15 = s.eVar28 = urlSplit[minorSectionIndex] || "";
        s.prop16 = s.eVar29 = urlSplit[minorSectionIndex+1] || "";
        pageNameString = urlSplit.splice(3).join(" | ");
        s.pageName = "jboss | community | " + siteName + " | " + pageNameString;
        s.server = "jboss";
        s.channel = "jboss | community";
        s.prop4 = s.eVar23 = encodeURI(document.URL);
        s.prop21 = s.eVar18 = coreUrl;
        s.prop2 = s.eVar22 = "en";
        s.prop3 = s.eVar19 = "us";
        //--></script> <script type="text/javascript" src="//www.redhat.com/j/rh_omni_footer.js"></script> <script language="JavaScript" type="text/javascript"><!--
        if(navigator.appVersion.indexOf('MSIE')>=0)document.write(unescape('%3C')+'\!-'+'-')
        //--></script> <noscript><a href="http://www.omniture.com" title="Web Analytics"><img src="https://smtrcs.redhat.com/b/ss/redhatcom,redhatglobal/1/H.25.4--NS/0?[AQB]&cdp=3&[AQE]" height="1" width="1" border="0" alt=""/></a></noscript> </div> <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
      </script> <script type="text/javascript">
      try {
      var pageTracker = _gat._getTracker("UA-10656779-1");
      pageTracker._trackPageview();
      } catch(err) {}</script> <script>
       (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
                          })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
       
      ga('create', 'UA-76464546-1', 'auto');
      ga('send', 'pageview');
      ga('set', 'anonymizeIp', true);
      ga('require', 'linkid', 'linkid.js');
      
      </script> </div> </body> </html>